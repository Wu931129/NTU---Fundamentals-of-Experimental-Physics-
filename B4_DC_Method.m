%% ===============================================
%  電流 vs. 角度(B - A) 迴歸分析與誤差傳遞 (最小平方法版)
%  新增x軸誤差顯示
% ===============================================

clc; clear; close all;

%% === Step 1. 輸入原始資料 (70筆，兩欄：電流 角度B-A) ===
data = [
0.9783	0.028309163
1.0098	0.020186036
1.0368	0.014681693
1.0518	0.013108845
1.0737	0.015730218
1.1087	0.01546809
1.1254	0.015992344
1.143	0.017040825
0.9563	0.01546809
0.9486	0.012322397
1.5037	0.026737203
1.5224	0.030666838
1.5124	0.028047179
1.5299	0.033024172
1.5497	0.034333645
1.5618	0.038784945
1.4805	0.030142939
1.4592	0.031452655
1.469	0.031452655
1.4428	0.035904857
2.0006	0.030142939
2.0133	0.031452655
1.9747	0.03119072
2.0552	0.035119272
1.9907	0.035904857
1.9566	0.037737712
2.02	0.037737712
1.9942	0.038261339
2.0139	0.037475891
1.9348	0.037999528
2.4848	0.041664391
2.474	0.040093867
2.4596	0.03930853
2.4415	0.038261339
2.5104	0.042449576
2.5336	0.043496408
2.5187	0.042711293
2.5241	0.042973004
2.5505	0.044019788
2.5293	0.043234709
2.8631	0.047944352
2.9927	0.048467519
3.1118	0.048205939
3.2015	0.048729092
3.2151	0.049252218
3.0714	0.048205939
2.9126	0.046113066
3.0314	0.04742116
3.1597	0.048990658
3.1355	0.049252218
0.5042	0.000262192
0.5163	0.000524384
0.4914	0.000786576
0.4827	0.001310959
0.5148	0.000262192
0.5016	0.000262192
0.5243	0.000524384
0.5167	0.000262192
0.4784	0.001048767
0.5358	0.00157315
0.2078	0.000786576
0.1905	0.00157315
0.1933	0.001048767
0.2046	0.001048767
0.2094	0.000262192
0.2081	0.000786576
0.197	0.00157315
0.1936	0.000524384
0.1957	0.000786576
0.2023	0.001310959
];

%% === Step 2. 分成 7 組 (每組10筆) ===
group_size = 10;
nGroup = size(data,1) / group_size;

x_mean = zeros(nGroup,1);
y_mean = zeros(nGroup,1);
x_std  = zeros(nGroup,1); % 新增 x 的誤差
y_std  = zeros(nGroup,1);

for i = 1:nGroup
    idx = (i-1)*group_size + (1:group_size);
    x = data(idx,1);
    y = data(idx,2);
    x_mean(i) = mean(x);
    y_mean(i) = mean(y);
    x_std(i)  = std(x);  % 計算 x 標準差
    y_std(i)  = std(y);
end

%% === Step 3. 使用最小平方法進行線性擬合 ===
x = x_mean; y = y_mean; n = length(x);
sumx = sum(x); sumy = sum(y);
sumx2 = sum(x.^2); sumxy = sum(x.*y);

a = (n*sumxy - sumx*sumy) / (n*sumx2 - sumx^2);
b = mean(y) - a*mean(x);

% --- 殘差平方和與誤差估計 ---
y_fit = a*x + b;
SSE = sum((y - y_fit).^2);
s2 = SSE / (n - 2);
Sxx = sum((x - mean(x)).^2);

sa = sqrt(s2 / Sxx);
sb = sqrt(s2 * (1/n + mean(x)^2 / Sxx));

%% === Step 4. 誤差傳遞 (Vd計算, 改用0.102) ===
Vd = a / (0.009742 * 0.102);
sVd = sa / (0.009742 * 0.102);

%% === Step 5. 結果輸出 ===
fprintf('--- 最小平方法線性擬合結果 ---\n');
fprintf('y = a*x + b\n');
fprintf('斜率 a = %.5f ± %.5f\n', a, sa);
fprintf('截距 b = %.5f ± %.5f\n', b, sb);
fprintf('V_d = %.5f ± %.5f\n\n', Vd, sVd);

fprintf('--- 七組平均與誤差 ---\n');
for i = 1:nGroup
    fprintf('第%d組: x̄ = %.4f ± %.4f, ȳ = %.4f ± %.4f\n', i, x_mean(i), x_std(i), y_mean(i), y_std(i));
end

%% === Step 6. 繪圖 (x, y 同時顯示 error bar) ===
figure;
errorbar(x_mean, y_mean, y_std, y_std, x_std, x_std, 'o', ...
         'MarkerFaceColor','b','MarkerEdgeColor','b','LineWidth',1.3); 
hold on;
x_fit_line = linspace(min(x_mean), max(x_mean), 200);
y_fit_line = a*x_fit_line + b;
plot(x_fit_line, y_fit_line, 'r-', 'LineWidth', 1.4);

xlabel('電流 (A)');
ylabel('角度差 B - A (rad)');
title('電流 vs. 角度(B - A) 最小平方法迴歸分析');
legend('平均值 (含誤差)', ...
       sprintf('線性擬合: y = %.4f(±%.4f)x + %.4f(±%.4f)', a, sa, b, sb), ...
       'Location','best');
grid on;

% --- 調整 y 軸範圍，讓最下方點不貼邊 ---
y_min = min(y_mean - y_std);
y_max = max(y_mean + y_std);
margin = 0.1 * (y_max - y_min);
ylim([y_min - margin/2, y_max + margin]);
